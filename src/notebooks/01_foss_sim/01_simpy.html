
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SimPy: Treatment Centre &#8212; Open Science for Computer Simulation</title>
    
  <link rel="stylesheet" href="../../../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../../_static/sphinx-book-theme.c441f2ba0852f4cabcb80105e3a46ae6.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/sphinx-book-theme.7d483ff0a819d6edff12ce0b1ead3928.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="CiW" href="02_ciw.html" />
    <link rel="prev" title="Welcome" href="../../front_page.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../../index.html">
  
  
  <h1 class="site-logo" id="site-title">Open Science for Computer Simulation</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../front_page.html">
   Welcome
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Simulation packages
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   SimPy: Treatment Centre
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_ciw.html">
   CiW
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Software environment
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../02_tools/01_virt_env.html">
   Virtual Environments
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../02_tools/02_docker.html">
   Docker
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../02_tools/03_version_control.html">
   Cloud version control
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Synthetic Data
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../03_data/01_smote.html">
   Synthetic Data
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Documentation
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../04_doc/01_jupyter.html">
   Jupyter notebooks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../04_doc/02_jupyterbooks.html">
   Jupyter Books
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Deployment
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../05_deployment/01_pypi.html">
   PyPi
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../05_deployment/02_binderhub.html">
   BinderHub
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../05_deployment/03_cloud_notebooks.html">
   Notebooks in the cloud
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../_sources/src/notebooks/01_foss_sim/01_simpy.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/TomMonks/open-science-for-sim"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/TomMonks/open-science-for-sim/issues/new?title=Issue%20on%20page%20%2Fsrc/notebooks/01_foss_sim/01_simpy.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>


            <!-- Full screen (wrap in <a> to have style consistency -->
            <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                    data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                    title="Fullscreen mode"><i
                        class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/TomMonks/open-science-for-sim/main?urlpath=tree/src/notebooks/01_foss_sim/01_simpy.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/TomMonks/open-science-for-sim/blob/main/src/notebooks/01_foss_sim/01_simpy.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../../../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i>
            Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#firsttreatment-a-health-clinic-based-in-the-us">
   FirstTreatment: A health clinic based in the US.
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#constants-and-defaults-for-modelling-as-is">
   Constants and defaults for modelling
   <strong>
    as-is
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#distribution-parameters">
     Distribution parameters
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#resource-counts">
     Resource counts
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simulation-model-run-settings">
     Simulation model run settings
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#utility-functions">
   Utility functions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#distribution-classes">
   Distribution classes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-parameterisation">
   Model parameterisation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#patient-pathways-process-logic">
   Patient Pathways Process Logic
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#main-model-class">
   Main model class
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#executing-a-model">
   Executing a model
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#single-run-of-the-model">
     Single run of the model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multiple-independent-replications">
     Multiple independent replications
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualise-replications">
     Visualise replications
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#script-to-run-scenario-analysis">
     Script to run scenario analysis
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#end">
   End
  </a>
 </li>
</ul>

        </nav>
        
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="simpy-treatment-centre">
<h1>SimPy: Treatment Centre<a class="headerlink" href="#simpy-treatment-centre" title="Permalink to this headline">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">simpy</span></code> uses process based model worldview.  Given its simplicity it is a highly flexible discrete-event simulation package.</p>
<p>One of the benefits of a package like <code class="docutils literal notranslate"><span class="pre">simpy</span></code> is that it is written in standard python and is free and open for others to use.</p>
<ul class="simple">
<li><p>For research this is highly beneficial:</p>
<ul>
<li><p>models and methods tested against them can be shared without concerns for commerical licensing.</p></li>
<li><p>experimental results (either from model or method) can be recreated by other research teams.</p></li>
</ul>
</li>
<li><p>The version of <code class="docutils literal notranslate"><span class="pre">simpy</span></code> in use can also be controlled.  This avoids backwards compatibility problems if models are returned to after several years.</p></li>
</ul>
<p>Here we will take a look at code that implements a full <code class="docutils literal notranslate"><span class="pre">simpy</span></code> model including, time dependent arrivals, results collection, control of random numbers and multiple replications.</p>
<blockquote>
<div><p>The full scope of what is possible in <code class="docutils literal notranslate"><span class="pre">simpy</span></code> it out of scope.  Detailed documentation for <code class="docutils literal notranslate"><span class="pre">simpy</span></code> and additional models can be found here: <a class="reference external" href="https://simpy.readthedocs.io/en/latest/">https://simpy.readthedocs.io/en/latest/</a></p>
</div></blockquote>
<hr class="docutils" />
<div class="section" id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h2>
<p>It is recommended that you use the provided conda virtual environment <code class="docutils literal notranslate"><span class="pre">os-sim</span></code>.</p>
<blockquote>
<div><p>If you are running this code in <strong>Google Colab</strong> then <code class="docutils literal notranslate"><span class="pre">simpy</span></code> can be pip installed.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># if running in Google Colab.</span>
<span class="c1">#!pip install simpy==4.0.1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">simpy</span>
<span class="n">simpy</span><span class="o">.</span><span class="n">__version__</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;3.0.12&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># need numpy &gt; v1.18</span>
<span class="n">np</span><span class="o">.</span><span class="n">__version__</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;1.19.1&#39;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="firsttreatment-a-health-clinic-based-in-the-us">
<h2>FirstTreatment: A health clinic based in the US.<a class="headerlink" href="#firsttreatment-a-health-clinic-based-in-the-us" title="Permalink to this headline">¶</a></h2>
<p>This example is based on exercise 13 from Nelson (2010) page 170.</p>
<blockquote>
<div><p>In this model treatment of trauma and non-trauma patients is modelled seperately.</p>
</div></blockquote>
</div>
<div class="section" id="constants-and-defaults-for-modelling-as-is">
<h2>Constants and defaults for modelling <strong>as-is</strong><a class="headerlink" href="#constants-and-defaults-for-modelling-as-is" title="Permalink to this headline">¶</a></h2>
<div class="section" id="distribution-parameters">
<h3>Distribution parameters<a class="headerlink" href="#distribution-parameters" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 4.8 minutes between arrivals (225 per 18 hours)</span>
<span class="n">DEFAULT_MEAN_IAT</span> <span class="o">=</span> <span class="mf">4.8</span>

<span class="c1"># sign-in/triage parameters</span>
<span class="n">DEFAULT_TRIAGE_MEAN</span> <span class="o">=</span> <span class="mf">3.0</span>

<span class="c1"># registration parameters</span>
<span class="n">DEFAULT_REG_MEAN</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">DEFAULT_REG_VAR</span><span class="o">=</span> <span class="mf">2.0</span>

<span class="c1"># examination parameters</span>
<span class="n">DEFAULT_EXAM_MEAN</span> <span class="o">=</span> <span class="mf">16.0</span>
<span class="n">DEFAULT_EXAM_VAR</span> <span class="o">=</span> <span class="mf">3.0</span>

<span class="c1"># trauma/stabilisation</span>
<span class="n">DEFAULT_TRAUMA_MEAN</span> <span class="o">=</span> <span class="mf">90.0</span>

<span class="c1"># Trauma treatment</span>
<span class="n">DEFAULT_TRAUMA_TREAT_MEAN</span> <span class="o">=</span> <span class="mf">30.0</span>
<span class="n">DEFAULT_TRAUMA_TREAT_VAR</span> <span class="o">=</span> <span class="mf">4.0</span>

<span class="c1"># Non trauma treatment</span>
<span class="n">DEFAULT_NON_TRAUMA_TREAT_MEAN</span> <span class="o">=</span> <span class="mf">13.3</span>
<span class="n">DEFAULT_NON_TRAUMA_TREAT_VAR</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="c1"># prob patient requires treatment given trauma</span>
<span class="n">DEFAULT_NON_TRAUMA_TREAT_P</span> <span class="o">=</span> <span class="mf">0.40</span>

<span class="c1"># proportion of patients triaged as trauma</span>
<span class="n">DEFAULT_PROB_TRAUMA</span> <span class="o">=</span> <span class="mf">0.12</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="resource-counts">
<h3>Resource counts<a class="headerlink" href="#resource-counts" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DEFAULT_N_TRIAGE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">DEFAULT_N_REG</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">DEFAULT_N_EXAM</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">DEFAULT_N_TRAUMA</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># Non-trauma cubicles</span>
<span class="n">DEFAULT_N_CUBICLES_1</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># trauma pathway cubicles</span>
<span class="n">DEFAULT_N_CUBICLES_2</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="simulation-model-run-settings">
<h3>Simulation model run settings<a class="headerlink" href="#simulation-model-run-settings" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># default random number SET</span>
<span class="n">DEFAULT_RNG_SET</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">N_STREAMS</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># default results collection period</span>
<span class="n">DEFAULT_RESULTS_COLLECTION_PERIOD</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">18</span>

<span class="c1"># number of replications.</span>
<span class="n">DEFAULT_N_REPS</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># Show the a trace of simulated events</span>
<span class="c1"># not recommended when running multiple replications</span>
<span class="n">TRACE</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="utility-functions">
<h2>Utility functions<a class="headerlink" href="#utility-functions" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Utility function for printing a trace as the</span>
<span class="sd">    simulation model executes.</span>
<span class="sd">    Set the TRACE constant to False, to turn tracing off.</span>
<span class="sd">    </span>
<span class="sd">    Params:</span>
<span class="sd">    -------</span>
<span class="sd">    msg: str</span>
<span class="sd">        string to print to screen.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">TRACE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="distribution-classes">
<h2>Distribution classes<a class="headerlink" href="#distribution-classes" title="Permalink to this headline">¶</a></h2>
<p>To help with controlling sampling <code class="docutils literal notranslate"><span class="pre">numpy</span></code> distributions are packaged up into classes that allow easy control of random numbers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Exponential</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convenience class for the exponential distribution.</span>
<span class="sd">    packages up distribution parameters, seed and random generator.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Constructor</span>
<span class="sd">        </span>
<span class="sd">        Params:</span>
<span class="sd">        ------</span>
<span class="sd">        mean: float</span>
<span class="sd">            The mean of the exponential distribution</span>
<span class="sd">        </span>
<span class="sd">        random_seed: int, optional (default=None)</span>
<span class="sd">            A random seed to reproduce samples.  If set to none then a unique</span>
<span class="sd">            sample is created.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span>
        
    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Generate a sample from the exponential distribution</span>
<span class="sd">        </span>
<span class="sd">        Params:</span>
<span class="sd">        -------</span>
<span class="sd">        size: int, optional (default=None)</span>
<span class="sd">            the number of samples to return.  If size=None then a single</span>
<span class="sd">            sample is returned.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>

    
<span class="k">class</span> <span class="nc">Bernoulli</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convenience class for the Bernoulli distribution.</span>
<span class="sd">    packages up distribution parameters, seed and random generator.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Constructor</span>
<span class="sd">        </span>
<span class="sd">        Params:</span>
<span class="sd">        ------</span>
<span class="sd">        p: float</span>
<span class="sd">            probability of drawing a 1</span>
<span class="sd">        </span>
<span class="sd">        random_seed: int, optional (default=None)</span>
<span class="sd">            A random seed to reproduce samples.  If set to none then a unique</span>
<span class="sd">            sample is created.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
        
    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Generate a sample from the exponential distribution</span>
<span class="sd">        </span>
<span class="sd">        Params:</span>
<span class="sd">        -------</span>
<span class="sd">        size: int, optional (default=None)</span>
<span class="sd">            the number of samples to return.  If size=None then a single</span>
<span class="sd">            sample is returned.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Lognormal</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encapsulates a lognormal distirbution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stdev</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Params:</span>
<span class="sd">        -------</span>
<span class="sd">        mean: float</span>
<span class="sd">            mean of the lognormal distribution</span>
<span class="sd">            </span>
<span class="sd">        stdev: float</span>
<span class="sd">            standard dev of the lognormal distribution</span>
<span class="sd">            </span>
<span class="sd">        random_seed: int, optional (default=None)</span>
<span class="sd">            Random seed to control sampling</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normal_moments_from_lognormal</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">stdev</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
        
    <span class="k">def</span> <span class="nf">normal_moments_from_lognormal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns mu and sigma of normal distribution</span>
<span class="sd">        underlying a lognormal with mean m and variance v</span>
<span class="sd">        source: https://blogs.sas.com/content/iml/2014/06/04/simulate-lognormal</span>
<span class="sd">        -data-with-specified-mean-and-variance.html</span>

<span class="sd">        Params:</span>
<span class="sd">        -------</span>
<span class="sd">        m: float</span>
<span class="sd">            mean of lognormal distribution</span>
<span class="sd">        v: float</span>
<span class="sd">            variance of lognormal distribution</span>
<span class="sd">                </span>
<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        (float, float)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="n">m</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">phi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span>
        
    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sample from the normal distribution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Normal</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convenience class for the normal distribution.</span>
<span class="sd">    packages up distribution parameters, seed and random generator.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Constructor</span>
<span class="sd">        </span>
<span class="sd">        Params:</span>
<span class="sd">        ------</span>
<span class="sd">        mean: float</span>
<span class="sd">            The mean of the normal distribution</span>
<span class="sd">            </span>
<span class="sd">        sigma: float</span>
<span class="sd">            The stdev of the normal distribution</span>
<span class="sd">        </span>
<span class="sd">        random_seed: int, optional (default=None)</span>
<span class="sd">            A random seed to reproduce samples.  If set to none then a unique</span>
<span class="sd">            sample is created.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
        
    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Generate a sample from the normal distribution</span>
<span class="sd">        </span>
<span class="sd">        Params:</span>
<span class="sd">        -------</span>
<span class="sd">        size: int, optional (default=None)</span>
<span class="sd">            the number of samples to return.  If size=None then a single</span>
<span class="sd">            sample is returned.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="model-parameterisation">
<h2>Model parameterisation<a class="headerlink" href="#model-parameterisation" title="Permalink to this headline">¶</a></h2>
<p>For convienience a container class is used to hold the large number of model parameters.  The <code class="docutils literal notranslate"><span class="pre">Scenario</span></code> class includes defaults  these can easily be changed and at runtime to experiments with different designs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Scenario</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Container class for scenario parameters/arguments</span>
<span class="sd">    </span>
<span class="sd">    Passed to a model and its process classes</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random_number_set</span><span class="o">=</span><span class="n">DEFAULT_RNG_SET</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The init method sets up our defaults.</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        random_number_set: int, optional (default=DEFAULT_RNG_SET)</span>
<span class="sd">            Set to control the initial seeds of each stream of pseudo</span>
<span class="sd">            random numbers used in the model.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># sampling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_number_set</span> <span class="o">=</span> <span class="n">random_number_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_sampling</span><span class="p">()</span>
        
        <span class="c1"># count of each type of resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_resourse_counts</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">set_random_no_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random_number_set</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Controls the random sampling </span>
<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        random_number_set: int</span>
<span class="sd">            Used to control the set of psuedo random numbers</span>
<span class="sd">            used by the distributions in the simulation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_number_set</span> <span class="o">=</span> <span class="n">random_number_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_sampling</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">init_resourse_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Init the counts of resources to default values...</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_triage</span> <span class="o">=</span> <span class="n">DEFAULT_N_TRIAGE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_reg</span> <span class="o">=</span> <span class="n">DEFAULT_N_REG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_exam</span> <span class="o">=</span> <span class="n">DEFAULT_N_EXAM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_trauma</span> <span class="o">=</span> <span class="n">DEFAULT_N_TRAUMA</span>
        
        <span class="c1"># non-trauma (1), trauma (2) treatment cubicles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_cubicles_1</span> <span class="o">=</span> <span class="n">DEFAULT_N_CUBICLES_1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_cubicles_2</span> <span class="o">=</span> <span class="n">DEFAULT_N_CUBICLES_2</span>

    <span class="k">def</span> <span class="nf">init_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create the distributions used by the model and initialise </span>
<span class="sd">        the random seeds of each.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># create random number streams</span>
        <span class="n">rng_streams</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_number_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seeds</span> <span class="o">=</span> <span class="n">rng_streams</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">999999999</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N_STREAMS</span><span class="p">)</span>

        <span class="c1"># create distributions</span>
        
        <span class="c1"># Triage duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triage_dist</span> <span class="o">=</span> <span class="n">Exponential</span><span class="p">(</span><span class="n">DEFAULT_TRIAGE_MEAN</span><span class="p">,</span> 
                                       <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="c1"># Registration duration (non-trauma only)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_dist</span> <span class="o">=</span> <span class="n">Lognormal</span><span class="p">(</span><span class="n">DEFAULT_REG_MEAN</span><span class="p">,</span> 
                                  <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">DEFAULT_REG_VAR</span><span class="p">),</span>
                                  <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="c1"># Evaluation (non-trauma only)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exam_dist</span> <span class="o">=</span> <span class="n">Normal</span><span class="p">(</span><span class="n">DEFAULT_EXAM_MEAN</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">DEFAULT_EXAM_VAR</span><span class="p">),</span>
                                <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="c1"># Trauma/stablisation duration (trauma only)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trauma_dist</span> <span class="o">=</span> <span class="n">Exponential</span><span class="p">(</span><span class="n">DEFAULT_TRAUMA_MEAN</span><span class="p">,</span> 
                                       <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        
        <span class="c1"># Non-trauma treatment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nt_treat_dist</span> <span class="o">=</span> <span class="n">Lognormal</span><span class="p">(</span><span class="n">DEFAULT_NON_TRAUMA_TREAT_MEAN</span><span class="p">,</span> 
                                       <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">DEFAULT_NON_TRAUMA_TREAT_VAR</span><span class="p">),</span>
                                       <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        
        <span class="c1"># treatment of trauma patients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">treat_dist</span> <span class="o">=</span> <span class="n">Lognormal</span><span class="p">(</span><span class="n">DEFAULT_TRAUMA_TREAT_MEAN</span><span class="p">,</span> 
                                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">DEFAULT_TRAUMA_TREAT_VAR</span><span class="p">),</span>
                                    <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        
        <span class="c1"># probability of non-trauma patient requiring treatment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nt_p_treat_dist</span> <span class="o">=</span> <span class="n">Bernoulli</span><span class="p">(</span><span class="n">DEFAULT_NON_TRAUMA_TREAT_P</span><span class="p">,</span> 
                                         <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
        
        
        <span class="c1"># probability of non-trauma versus trauma patient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_trauma_dist</span> <span class="o">=</span> <span class="n">Bernoulli</span><span class="p">(</span><span class="n">DEFAULT_PROB_TRAUMA</span><span class="p">,</span> 
                                       <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
        
        <span class="c1"># arrivals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arrival_dist</span> <span class="o">=</span> <span class="n">Exponential</span><span class="p">(</span><span class="n">DEFAULT_MEAN_IAT</span><span class="p">,</span>
                                       <span class="n">random_seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="patient-pathways-process-logic">
<h2>Patient Pathways Process Logic<a class="headerlink" href="#patient-pathways-process-logic" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">simpy</span></code> uses a process based worldview.  We can easily create whatever logic - simple or complex  for the model.  Here the process logic for trauma and non-trauma patients is seperated into two classes <code class="docutils literal notranslate"><span class="pre">TraumaPathway</span></code>  and <code class="docutils literal notranslate"><span class="pre">NonTraumaPathway</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TraumaPathway</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Encapsulates the process a patient with severe injuries or illness.</span>
<span class="sd">    </span>
<span class="sd">    These patients are signed into the ED and triaged as having severe injuries</span>
<span class="sd">    or illness.</span>
<span class="sd">    </span>
<span class="sd">    Patients are stabilised in resus (trauma) and then sent to Treatment.  </span>
<span class="sd">    Following treatment they are discharged.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Constructor method</span>
<span class="sd">        </span>
<span class="sd">        Params:</span>
<span class="sd">        -----</span>
<span class="sd">        identifier: int</span>
<span class="sd">            a numeric identifier for the patient.</span>
<span class="sd">            </span>
<span class="sd">        env: simpy.Environment</span>
<span class="sd">            the simulation environment</span>
<span class="sd">            </span>
<span class="sd">        args: Scenario</span>
<span class="sd">            Container class for the simulation parameters</span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        
        <span class="c1"># metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_triage</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_trauma</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_treat</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        simulates the major treatment process for a patient</span>
<span class="sd">        </span>
<span class="sd">        1. request and wait for sign-in/triage</span>
<span class="sd">        2. trauma</span>
<span class="sd">        3. treatment</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># record the time of arrival and entered the triage queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>

        <span class="c1"># request sign-in/triage </span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">triage</span><span class="o">.</span><span class="n">request</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">req</span>
            <span class="c1"># record the waiting time for triage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_triage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>     
            
            <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s1"> triaged to trauma &#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
            <span class="c1"># sample triage duration.</span>
            <span class="n">triage_duration</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">triage_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">triage_duration</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triage_complete</span><span class="p">()</span>
            
        <span class="c1"># record the time that entered the trauma queue</span>
        <span class="n">start_wait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
    
        <span class="c1"># request trauma room </span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">trauma</span><span class="o">.</span><span class="n">request</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">req</span>
            
            <span class="c1"># record the waiting time for trauma</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_trauma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">start_wait</span>
            
            <span class="c1"># sample stablisation duration.</span>
            <span class="n">trauma_duration</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">trauma_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">trauma_duration</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">trauma_complete</span><span class="p">()</span>
            
        <span class="c1"># record the time that entered the treatment queue</span>
        <span class="n">start_wait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
    
        <span class="c1"># request treatment cubicle </span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">cubicle_2</span><span class="o">.</span><span class="n">request</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">req</span>
            
            <span class="c1"># record the waiting time for trauma</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_treat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">start_wait</span>
            <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;treatment of patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s1"> at &#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="c1"># sample treatment duration.</span>
            <span class="n">treat_duration</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">trauma_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">treat_duration</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">treatment_complete</span><span class="p">()</span>
        
        <span class="c1"># total time in system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>     
            
    <span class="k">def</span> <span class="nf">triage_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Triage complete event</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;triage </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s1"> complete </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">; &#39;</span>
              <span class="sa">f</span><span class="s1">&#39;waiting time was </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wait_triage</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
          
    <span class="k">def</span> <span class="nf">trauma_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Patient stay in trauma is complete.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;stabilisation of patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s1"> at &#39;</span>
              <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">treatment_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Treatment complete event</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s1"> treatment complete </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">; &#39;</span>
        <span class="sa">f</span><span class="s1">&#39;waiting time was </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wait_treat</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NonTraumaPathway</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Encapsulates the process a patient with minor injuries and illness.</span>
<span class="sd">    </span>
<span class="sd">    These patients are signed into the ED and triaged as having minor </span>
<span class="sd">    complaints and streamed to registration and then examination. </span>
<span class="sd">    </span>
<span class="sd">    Post examination 40% are discharged while 60% proceed to treatment.  </span>
<span class="sd">    Following treatment they are discharged.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Constructor method</span>
<span class="sd">        </span>
<span class="sd">        Params:</span>
<span class="sd">        -----</span>
<span class="sd">        identifier: int</span>
<span class="sd">            a numeric identifier for the patient.</span>
<span class="sd">            </span>
<span class="sd">        env: simpy.Environment</span>
<span class="sd">            the simulation environment</span>
<span class="sd">            </span>
<span class="sd">        args: Scenario</span>
<span class="sd">            Container class for the simulation parameters</span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        
        <span class="c1"># triage resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triage</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">triage</span>
        
        <span class="c1"># metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_triage</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_reg</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_eval</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_treat</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">triage_duration</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_duration</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_duration</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">treat_duration</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        
        
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        simulates the non-trauma/minor treatment process for a patient</span>
<span class="sd">        </span>
<span class="sd">        1. request and wait for sign-in/triage</span>
<span class="sd">        2. patient registration</span>
<span class="sd">        3. evaluation</span>
<span class="sd">        4.1 40% discharged</span>
<span class="sd">        4.2 60% treatment then discharge</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># record the time of arrival and entered the triage queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>

        <span class="c1"># request sign-in/triage </span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">triage</span><span class="o">.</span><span class="n">request</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">req</span>
            
            <span class="c1"># record the waiting time for triage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_triage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>
            <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s1"> triaged to minors &#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="c1"># sample triage duration.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triage_duration</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">triage_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">triage_duration</span><span class="p">)</span>
            
            <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;triage </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s1"> complete </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">; &#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;waiting time was </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wait_triage</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="c1"># record the time that entered the registration queue</span>
        <span class="n">start_wait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
    
        <span class="c1"># request registration clert </span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">registration</span><span class="o">.</span><span class="n">request</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">req</span>
            
            <span class="c1"># record the waiting time for registration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">start_wait</span>
            <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;registration of patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s1"> at &#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="c1"># sample registration duration.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reg_duration</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">reg_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_duration</span><span class="p">)</span>
            
            <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s1"> registered at&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">; &#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;waiting time was </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wait_reg</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="c1"># record the time that entered the evaluation queue</span>
        <span class="n">start_wait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
    
        <span class="c1"># request evaluation resource</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">exam</span><span class="o">.</span><span class="n">request</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">req</span>
            
            <span class="c1"># record the waiting time for registration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_eval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">start_wait</span>
            <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;evaluation of patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s1"> begins &#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="c1"># sample evaluation duration.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_duration</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">exam_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_duration</span><span class="p">)</span>
            
            <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s1"> evaluation complete &#39;</span> 
                  <span class="sa">f</span><span class="s1">&#39;at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">;&#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;waiting time was </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wait_eval</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="c1"># sample if patient requires treatment?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_treat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">nt_p_treat_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">require_treat</span><span class="p">:</span>
        
            <span class="c1"># record the time that entered the treatment queue</span>
            <span class="n">start_wait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
    
            <span class="c1"># request treatment cubicle</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">cubicle_1</span><span class="o">.</span><span class="n">request</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">req</span>

                <span class="c1"># record the waiting time for treatment</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wait_treat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">start_wait</span>
                <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;treatment of patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s1"> begins &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1"># sample treatment duration.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">treat_duration</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">nt_treat_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">treat_duration</span><span class="p">)</span>

                <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;patient </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s1"> treatment complete &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">;&#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;waiting time was </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wait_treat</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
        <span class="c1"># total time in system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival</span>      
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="main-model-class">
<h2>Main model class<a class="headerlink" href="#main-model-class" title="Permalink to this headline">¶</a></h2>
<p>The main class that a user interacts with to run the model is <code class="docutils literal notranslate"><span class="pre">TreatmentCentreModel</span></code>.  This implements a <code class="docutils literal notranslate"><span class="pre">.run()</span></code> method, contains a process for patients arrivals and inits instances of <code class="docutils literal notranslate"><span class="pre">TraumaPathway</span></code> or <code class="docutils literal notranslate"><span class="pre">NonTraumaPathway</span></code> depending on the arrival type.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TreatmentCentreModel</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The treatment centre model</span>
<span class="sd">    </span>
<span class="sd">    Patients arrive at random to a treatment centre, are triaged</span>
<span class="sd">    and then processed in either a trauma or non-trauma pathway.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_resources</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">patients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trauma_patients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_trauma_patients</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rc_period</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">init_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Init the number of resources</span>
<span class="sd">        and store in the arguments container object</span>
<span class="sd">        </span>
<span class="sd">        Resource list:</span>
<span class="sd">        1. Sign-in/triage bays</span>
<span class="sd">        2. registration clerks</span>
<span class="sd">        3. examination bays</span>
<span class="sd">        4. trauma bays</span>
<span class="sd">        5. non-trauma cubicles (1)</span>
<span class="sd">        6. trauma cubicles (2)</span>
<span class="sd">         </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># sign/in triage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">triage</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> 
                                          <span class="n">capacity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_triage</span><span class="p">)</span>
        
        <span class="c1"># registration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">registration</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> 
                                                <span class="n">capacity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_reg</span><span class="p">)</span>
        
        <span class="c1"># examination</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">exam</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> 
                                        <span class="n">capacity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_exam</span><span class="p">)</span>
        
        <span class="c1"># trauma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">trauma</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> 
                                          <span class="n">capacity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_trauma</span><span class="p">)</span>
        
        <span class="c1"># non-trauma treatment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">cubicle_1</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> 
                                              <span class="n">capacity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_cubicles_1</span><span class="p">)</span>
            
        <span class="c1"># trauma treatment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">cubicle_2</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> 
                                              <span class="n">capacity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_cubicles_2</span><span class="p">)</span>
        
        
        
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results_collection_period</span><span class="o">=</span><span class="n">DEFAULT_RESULTS_COLLECTION_PERIOD</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Conduct a single run of the model in its current </span>
<span class="sd">        configuration</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        results_collection_period, float, optional</span>
<span class="sd">            default = DEFAULT_RESULTS_COLLECTION_PERIOD</span>
<span class="sd">            </span>
<span class="sd">        warm_up, float, optional (default=0)</span>
<span class="sd">        </span>
<span class="sd">            length of initial transient period to truncate</span>
<span class="sd">            from results.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">            None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># setup the arrival generator process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arrivals_generator</span><span class="p">())</span>
        
        <span class="c1"># store rc perio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rc_period</span> <span class="o">=</span> <span class="n">results_collection_period</span>
        
        <span class="c1"># run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="n">results_collection_period</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">arrivals_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Simulate the arrival of patients to the model</span>
<span class="sd">        </span>
<span class="sd">        Patients either follow a TraumaPathway or</span>
<span class="sd">        NonTraumaPathway simpy process.</span>
<span class="sd">        </span>
<span class="sd">        Implementation with as a stationary poisson process.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">patient_count</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            
            <span class="c1"># iat</span>
            <span class="n">inter_arrival_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">arrival_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">inter_arrival_time</span><span class="p">)</span>
            
            <span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;patient </span><span class="si">{</span><span class="n">patient_count</span><span class="si">}</span><span class="s1"> arrives at: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="c1"># sample if the patient is trauma or non-trauma</span>
            <span class="n">trauma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">p_trauma_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">trauma</span><span class="p">:</span>
                <span class="c1"># create and store a trauma patient to update KPIs.</span>
                <span class="n">new_patient</span> <span class="o">=</span> <span class="n">TraumaPathway</span><span class="p">(</span><span class="n">patient_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trauma_patients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_patient</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># create and store a non-trauma patient to update KPIs.</span>
                <span class="n">new_patient</span> <span class="o">=</span> <span class="n">NonTraumaPathway</span><span class="p">(</span><span class="n">patient_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">non_trauma_patients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_patient</span><span class="p">)</span>
                
            <span class="c1"># start the pathway process for the patient</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">new_patient</span><span class="o">.</span><span class="n">execute</span><span class="p">())</span>

    
    <span class="k">def</span> <span class="nf">process_run_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates statistics at end of run.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># mean triage times (both types of patient)</span>
        <span class="n">mean_triage_wait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mean_metric</span><span class="p">(</span><span class="s1">&#39;wait_triage&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_trauma_patients</span>
                                              <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">trauma_patients</span><span class="p">)</span>
        
        <span class="c1"># mean waiting time for registration (non_trauma)</span>
        <span class="n">mean_reg_wait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mean_metric</span><span class="p">(</span><span class="s1">&#39;wait_reg&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_trauma_patients</span><span class="p">)</span>
        
        <span class="c1"># mean waiting time for examination (non_trauma)</span>
        <span class="n">mean_wait_eval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mean_metric</span><span class="p">(</span><span class="s1">&#39;wait_eval&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_trauma_patients</span><span class="p">)</span>
        
        <span class="c1"># mean waiting time for treatment (non-trauma) </span>
        <span class="n">mean_treat_wait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mean_metric</span><span class="p">(</span><span class="s1">&#39;wait_treat&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_trauma_patients</span><span class="p">)</span>
        
        <span class="c1"># treatment utilisation (non_trauma)</span>
        <span class="n">treat_util1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resource_util</span><span class="p">(</span><span class="s1">&#39;treat_duration&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">n_cubicles_1</span><span class="p">,</span> 
                                             <span class="bp">self</span><span class="o">.</span><span class="n">non_trauma_patients</span><span class="p">)</span>
        
        <span class="c1"># mean total time (non_trauma)</span>
        <span class="n">mean_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mean_metric</span><span class="p">(</span><span class="s1">&#39;total_time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_trauma_patients</span><span class="p">)</span>
                                    
        <span class="c1"># mean waiting time for trauma </span>
        <span class="n">mean_trauma_wait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mean_metric</span><span class="p">(</span><span class="s1">&#39;wait_trauma&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trauma_patients</span><span class="p">)</span>
        
        <span class="c1"># mean waiting time for treatment (rauma) </span>
        <span class="n">mean_treat_wait2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mean_metric</span><span class="p">(</span><span class="s1">&#39;wait_treat&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trauma_patients</span><span class="p">)</span>
    
    
        <span class="c1"># mean total time (trauma)</span>
        <span class="n">mean_total2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mean_metric</span><span class="p">(</span><span class="s1">&#39;total_time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trauma_patients</span><span class="p">)</span>
        
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;01_triage_wait&#39;</span><span class="p">:</span> <span class="n">mean_triage_wait</span><span class="p">,</span>
                        <span class="s1">&#39;02_registration_wait&#39;</span><span class="p">:</span><span class="n">mean_reg_wait</span><span class="p">,</span>
                        <span class="s1">&#39;03_examination_wait&#39;</span><span class="p">:</span><span class="n">mean_wait_eval</span><span class="p">,</span>
                        <span class="s1">&#39;04a_treatment_wait(non_trauma)&#39;</span><span class="p">:</span><span class="n">mean_treat_wait</span><span class="p">,</span>
                        <span class="s1">&#39;04b_treatment_util(non_trauma)&#39;</span><span class="p">:</span><span class="n">treat_util1</span><span class="p">,</span>
                        <span class="s1">&#39;05_total_time(non-trauma)&#39;</span><span class="p">:</span><span class="n">mean_total</span><span class="p">,</span>
                        <span class="s1">&#39;06_trauma_wait&#39;</span><span class="p">:</span><span class="n">mean_trauma_wait</span><span class="p">,</span>
                        <span class="s1">&#39;07_treatment_wait(trauma)&#39;</span><span class="p">:</span><span class="n">mean_treat_wait2</span><span class="p">,</span>
                        <span class="s1">&#39;08_total_time(trauma)&#39;</span><span class="p">:</span><span class="n">mean_total2</span><span class="p">}</span>
        
    <span class="k">def</span> <span class="nf">get_mean_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">patients</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate mean of the performance measure for the</span>
<span class="sd">        select cohort of patients,</span>
<span class="sd">        </span>
<span class="sd">        Only calculates metrics for patients where it has been </span>
<span class="sd">        measured.</span>
<span class="sd">        </span>
<span class="sd">        Params:</span>
<span class="sd">        -------</span>
<span class="sd">        metric: str</span>
<span class="sd">            The name of the metric e.g. &#39;wait_treat&#39;</span>
<span class="sd">            </span>
<span class="sd">        patients: list</span>
<span class="sd">            A list of patients</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patients</span> 
                         <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">mean</span>
    
    
    <span class="k">def</span> <span class="nf">get_resource_util</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">n_resources</span><span class="p">,</span> <span class="n">patients</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate proportion of the results collection period</span>
<span class="sd">        where a resource was in use.</span>
<span class="sd">        </span>
<span class="sd">        Done by tracking the duration by patient.</span>
<span class="sd">        </span>
<span class="sd">        Only calculates metrics for patients where it has been </span>
<span class="sd">        measured.</span>
<span class="sd">        </span>
<span class="sd">        Params:</span>
<span class="sd">        -------</span>
<span class="sd">        metric: str</span>
<span class="sd">            The name of the metric e.g. &#39;treatment_duration&#39;</span>
<span class="sd">            </span>
<span class="sd">        patients: list</span>
<span class="sd">            A list of patients</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patients</span> 
                         <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
        
        <span class="k">return</span> <span class="n">total</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rc_period</span> <span class="o">*</span> <span class="n">n_resources</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">run_summary_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns run results as a pandas.DataFrame</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#append to results df</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_run_results</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;1&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">})</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;rep&#39;</span>
        <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="executing-a-model">
<h2>Executing a model<a class="headerlink" href="#executing-a-model" title="Permalink to this headline">¶</a></h2>
<p>We note that there are <strong>many ways</strong> to setup a <code class="docutils literal notranslate"><span class="pre">simpy</span></code> model and execute it (that is part of its fantastic flexibility).  The organisation of code we show below is based on our experience of using the package in practice. The approach also allows for easy parallisation over multiple CPU cores using <code class="docutils literal notranslate"><span class="pre">joblib</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">single_run</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">rc_period</span><span class="o">=</span><span class="n">DEFAULT_RESULTS_COLLECTION_PERIOD</span><span class="p">,</span> 
               <span class="n">random_no_set</span><span class="o">=</span><span class="n">DEFAULT_RNG_SET</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Perform a single run of the model and return the results</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    </span>
<span class="sd">    scenario: Scenario object</span>
<span class="sd">        The scenario/paramaters to run</span>
<span class="sd">        </span>
<span class="sd">    rc_period: int</span>
<span class="sd">        The length of the simulation run that collects results</span>
<span class="sd">        </span>
<span class="sd">    random_no_set: int or None, optional (default=DEFAULT_RNG_SET)</span>
<span class="sd">        Controls the set of random seeds used by the stochastic parts of the </span>
<span class="sd">        model.  Set to different ints to get different results.  Set to None</span>
<span class="sd">        for a random set of seeds.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">        pandas.DataFrame:</span>
<span class="sd">        results from single run.</span>
<span class="sd">    &#39;&#39;&#39;</span>  
        
    <span class="c1"># set random number set - this controls sampling for the run.</span>
    <span class="n">scenario</span><span class="o">.</span><span class="n">set_random_no_set</span><span class="p">(</span><span class="n">random_no_set</span><span class="p">)</span>

    <span class="c1"># create an instance of the model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">TreatmentCentreModel</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>

    <span class="c1"># run the model</span>
    <span class="n">model</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">results_collection_period</span><span class="o">=</span><span class="n">rc_period</span><span class="p">)</span>
    
    <span class="c1"># run results</span>
    <span class="n">results_summary</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run_summary_frame</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">results_summary</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">multiple_replications</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">rc_period</span><span class="o">=</span><span class="n">DEFAULT_RESULTS_COLLECTION_PERIOD</span><span class="p">,</span> 
                          <span class="n">n_reps</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Perform multiple replications of the model.</span>
<span class="sd">    </span>
<span class="sd">    Params:</span>
<span class="sd">    ------</span>
<span class="sd">    scenario: Scenario</span>
<span class="sd">        Parameters/arguments to configurethe model</span>
<span class="sd">    </span>
<span class="sd">    rc_period: float, optional (default=DEFAULT_RESULTS_COLLECTION_PERIOD)</span>
<span class="sd">        results collection period.  </span>
<span class="sd">        the number of minutes to run the model to collect results</span>

<span class="sd">    n_reps: int, optional (default=DEFAULT_N_REPS)</span>
<span class="sd">        Number of independent replications to run.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">single_run</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">rc_period</span><span class="p">,</span> <span class="n">random_no_set</span><span class="o">=</span><span class="n">rep</span><span class="p">)</span> 
               <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_reps</span><span class="p">)]</span>
    
    <span class="c1">#format and return results in a dataframe</span>
    <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="n">df_results</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_results</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df_results</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;rep&#39;</span>
    <span class="k">return</span> <span class="n">df_results</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="single-run-of-the-model">
<h3>Single run of the model<a class="headerlink" href="#single-run-of-the-model" title="Permalink to this headline">¶</a></h3>
<p>The script below performs a single replication of the simulation model.</p>
<p><strong>Try:</strong></p>
<ul class="simple">
<li><p>Changing the <code class="docutils literal notranslate"><span class="pre">random_no_set</span></code> of the <code class="docutils literal notranslate"><span class="pre">single_run</span></code> call.</p></li>
<li><p>Assigning the value <code class="docutils literal notranslate"><span class="pre">True</span></code> to <code class="docutils literal notranslate"><span class="pre">TRACE</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Change this to True to see a trace...</span>
<span class="n">TRACE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># create the default scenario</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">()</span>

<span class="c1"># use the single_run() func</span>
<span class="c1"># try changing `random_no_set` to see different run results</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running simulation ...&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; =&gt; &#39;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">single_run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">random_no_set</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;simulation complete.&#39;</span><span class="p">)</span>

<span class="c1"># show results (transpose replication for easier view)</span>
<span class="n">results</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Running simulation ... =&gt; simulation complete.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>rep</th>
      <th>1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>01_triage_wait</th>
      <td>9.477675</td>
    </tr>
    <tr>
      <th>02_registration_wait</th>
      <td>21.831100</td>
    </tr>
    <tr>
      <th>03_examination_wait</th>
      <td>31.882359</td>
    </tr>
    <tr>
      <th>04a_treatment_wait(non_trauma)</th>
      <td>39.918199</td>
    </tr>
    <tr>
      <th>04b_treatment_util(non_trauma)</th>
      <td>0.911153</td>
    </tr>
    <tr>
      <th>05_total_time(non-trauma)</th>
      <td>104.519820</td>
    </tr>
    <tr>
      <th>06_trauma_wait</th>
      <td>102.766784</td>
    </tr>
    <tr>
      <th>07_treatment_wait(trauma)</th>
      <td>98.844965</td>
    </tr>
    <tr>
      <th>08_total_time(trauma)</th>
      <td>404.259001</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="multiple-independent-replications">
<h3>Multiple independent replications<a class="headerlink" href="#multiple-independent-replications" title="Permalink to this headline">¶</a></h3>
<p>Given the set up it is now easy to perform multiple replications of the model.</p>
<p><strong>Try</strong>:</p>
<ul class="simple">
<li><p>Changing <code class="docutils literal notranslate"><span class="pre">n_reps</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">args</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">()</span>

<span class="c1">#run multiple replications.</span>
<span class="c1">#by default it runs 5 replications.</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running multiple replications&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; =&gt; &#39;</span><span class="p">)</span>
<span class="n">results</span>  <span class="o">=</span> <span class="n">multiple_replications</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">n_reps</span><span class="o">=</span><span class="mi">29</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Running multiple replications =&gt; 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>done.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>01_triage_wait</th>
      <th>02_registration_wait</th>
      <th>03_examination_wait</th>
      <th>04a_treatment_wait(non_trauma)</th>
      <th>04b_treatment_util(non_trauma)</th>
      <th>05_total_time(non-trauma)</th>
      <th>06_trauma_wait</th>
      <th>07_treatment_wait(trauma)</th>
      <th>08_total_time(trauma)</th>
    </tr>
    <tr>
      <th>rep</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>3.014604</td>
      <td>23.498323</td>
      <td>9.792361</td>
      <td>30.135838</td>
      <td>0.926755</td>
      <td>74.914566</td>
      <td>0.062229</td>
      <td>171.961575</td>
      <td>325.007291</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2.508414</td>
      <td>10.676678</td>
      <td>9.964669</td>
      <td>21.380342</td>
      <td>0.808727</td>
      <td>60.237301</td>
      <td>47.257427</td>
      <td>256.538520</td>
      <td>421.057708</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2.769040</td>
      <td>12.686761</td>
      <td>16.612949</td>
      <td>20.298664</td>
      <td>0.825390</td>
      <td>66.524033</td>
      <td>11.323200</td>
      <td>417.718579</td>
      <td>531.281948</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4.917449</td>
      <td>23.363841</td>
      <td>10.008536</td>
      <td>43.689602</td>
      <td>0.932013</td>
      <td>84.710628</td>
      <td>117.631635</td>
      <td>159.474612</td>
      <td>387.838806</td>
    </tr>
    <tr>
      <th>5</th>
      <td>4.417272</td>
      <td>14.334339</td>
      <td>11.289709</td>
      <td>15.100314</td>
      <td>0.839005</td>
      <td>60.993556</td>
      <td>72.603034</td>
      <td>69.665962</td>
      <td>312.832021</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># summarise the results (2.dp)</span>
<span class="n">results</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>01_triage_wait                      4.45
02_registration_wait               19.41
03_examination_wait                10.73
04a_treatment_wait(non_trauma)     33.12
04b_treatment_util(non_trauma)      0.86
05_total_time(non-trauma)          75.35
06_trauma_wait                     67.87
07_treatment_wait(trauma)         211.81
08_total_time(trauma)             395.34
dtype: float64
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="visualise-replications">
<h3>Visualise replications<a class="headerlink" href="#visualise-replications" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;01_triage_wait&#39;</span><span class="p">]);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;wait for triage&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;02_registration_wait&#39;</span><span class="p">]);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;wait for registration&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/01_simpy_35_0.png" src="../../../_images/01_simpy_35_0.png" />
</div>
</div>
<p>## Scenario Analysis</p>
<p>The structured approach we took to organising our <code class="docutils literal notranslate"><span class="pre">simpy</span></code> model allows us to easily experiment with alternative scenarios.  We could employ a formal experimental design if needed.  For simplicity here we will limit ourselves by running two competing scenarios and compare their mean performance to the base case.</p>
<blockquote>
<div><p>Note that we have our <code class="docutils literal notranslate"><span class="pre">simpy</span></code> model includes an implementation of Common Random Numbers across scenarios.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_scenarios</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Creates a dictionary object containing</span>
<span class="sd">    objects of type `Scenario` to run.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    dict</span>
<span class="sd">        Contains the scenarios for the model</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">scenarios</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">scenarios</span><span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">()</span>
    
    <span class="c1"># extra triage capacity</span>
    <span class="n">scenarios</span><span class="p">[</span><span class="s1">&#39;triage+1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">()</span>
    <span class="n">scenarios</span><span class="p">[</span><span class="s1">&#39;triage+1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n_triage</span> <span class="o">+=</span> <span class="mi">1</span>
        
    <span class="c1"># extra examination capacity</span>
    <span class="n">scenarios</span><span class="p">[</span><span class="s1">&#39;exam+1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">()</span>
    <span class="n">scenarios</span><span class="p">[</span><span class="s1">&#39;exam+1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n_exam</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c1"># extra non-trauma treatment capacity</span>
    <span class="n">scenarios</span><span class="p">[</span><span class="s1">&#39;treat+1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">()</span>
    <span class="n">scenarios</span><span class="p">[</span><span class="s1">&#39;treat+1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n_cubicles_1</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="n">scenarios</span><span class="p">[</span><span class="s1">&#39;triage+exam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">()</span>
    <span class="n">scenarios</span><span class="p">[</span><span class="s1">&#39;triage+exam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n_triage</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">scenarios</span><span class="p">[</span><span class="s1">&#39;triage+exam&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n_exam</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">return</span> <span class="n">scenarios</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_scenario_analysis</span><span class="p">(</span><span class="n">scenarios</span><span class="p">,</span> <span class="n">rc_period</span><span class="p">,</span> <span class="n">n_reps</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Run each of the scenarios for a specified results</span>
<span class="sd">    collection period and replications.</span>
<span class="sd">    </span>
<span class="sd">    Params:</span>
<span class="sd">    ------</span>
<span class="sd">    scenarios: dict</span>
<span class="sd">        dictionary of Scenario objects</span>
<span class="sd">        </span>
<span class="sd">    rc_period: float</span>
<span class="sd">        model run length</span>
<span class="sd">        </span>
<span class="sd">    n_rep: int</span>
<span class="sd">        Number of replications</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scenario Analysis&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No. Scenario: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">scenarios</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Replications: </span><span class="si">{</span><span class="n">n_reps</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">scenario_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">sc_name</span><span class="p">,</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running </span><span class="si">{</span><span class="n">sc_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; =&gt; &#39;</span><span class="p">)</span>
        <span class="n">replications</span> <span class="o">=</span> <span class="n">multiple_replications</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">rc_period</span><span class="o">=</span><span class="n">rc_period</span><span class="p">,</span>
                                              <span class="n">n_reps</span><span class="o">=</span><span class="n">n_reps</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1">#save the results</span>
        <span class="n">scenario_results</span><span class="p">[</span><span class="n">sc_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">replications</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scenario analysis complete.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scenario_results</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="script-to-run-scenario-analysis">
<h3>Script to run scenario analysis<a class="headerlink" href="#script-to-run-scenario-analysis" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#number of replications</span>
<span class="n">N_REPS</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1">#get the scenarios</span>
<span class="n">scenarios</span> <span class="o">=</span> <span class="n">get_scenarios</span><span class="p">()</span>

<span class="c1">#run the scenario analysis</span>
<span class="n">scenario_results</span> <span class="o">=</span> <span class="n">run_scenario_analysis</span><span class="p">(</span><span class="n">scenarios</span><span class="p">,</span> 
                                         <span class="n">DEFAULT_RESULTS_COLLECTION_PERIOD</span><span class="p">,</span>
                                         <span class="n">N_REPS</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Scenario Analysis
No. Scenario: 5
Replications: 20
Running base =&gt; 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>done.

Running triage+1 =&gt; 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>done.

Running exam+1 =&gt; 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>done.

Running treat+1 =&gt; 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>done.

Running triage+exam =&gt; 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>done.

Scenario analysis complete.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">scenario_summary_frame</span><span class="p">(</span><span class="n">scenario_results</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Mean results for each performance measure by scenario</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    scenario_results: dict</span>
<span class="sd">        dictionary of replications.  </span>
<span class="sd">        Key identifies the performance measure</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">sc_name</span><span class="p">,</span> <span class="n">replications</span> <span class="ow">in</span> <span class="n">scenario_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">summary</span><span class="p">,</span> <span class="n">replications</span><span class="o">.</span><span class="n">mean</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sc_name</span><span class="p">)</span>

    <span class="n">summary</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>
    <span class="k">return</span> <span class="n">summary</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># as well as rounding you may want to rename the cols/rows to </span>
<span class="c1"># more readable alternatives.</span>
<span class="n">summary_frame</span> <span class="o">=</span> <span class="n">scenario_summary_frame</span><span class="p">(</span><span class="n">scenario_results</span><span class="p">)</span>
<span class="n">summary_frame</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>base</th>
      <th>triage+1</th>
      <th>exam+1</th>
      <th>treat+1</th>
      <th>triage+exam</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>01_triage_wait</th>
      <td>4.05</td>
      <td>0.36</td>
      <td>5.25</td>
      <td>4.99</td>
      <td>0.33</td>
    </tr>
    <tr>
      <th>02_registration_wait</th>
      <td>18.80</td>
      <td>17.79</td>
      <td>18.93</td>
      <td>16.53</td>
      <td>18.07</td>
    </tr>
    <tr>
      <th>03_examination_wait</th>
      <td>10.59</td>
      <td>10.29</td>
      <td>0.12</td>
      <td>11.13</td>
      <td>0.12</td>
    </tr>
    <tr>
      <th>04a_treatment_wait(non_trauma)</th>
      <td>25.48</td>
      <td>28.40</td>
      <td>31.07</td>
      <td>0.61</td>
      <td>32.59</td>
    </tr>
    <tr>
      <th>04b_treatment_util(non_trauma)</th>
      <td>0.84</td>
      <td>0.85</td>
      <td>0.86</td>
      <td>0.44</td>
      <td>0.86</td>
    </tr>
    <tr>
      <th>05_total_time(non-trauma)</th>
      <td>70.51</td>
      <td>66.64</td>
      <td>64.53</td>
      <td>61.04</td>
      <td>59.17</td>
    </tr>
    <tr>
      <th>06_trauma_wait</th>
      <td>82.32</td>
      <td>86.79</td>
      <td>66.32</td>
      <td>65.54</td>
      <td>78.40</td>
    </tr>
    <tr>
      <th>07_treatment_wait(trauma)</th>
      <td>205.61</td>
      <td>135.37</td>
      <td>194.17</td>
      <td>164.45</td>
      <td>150.34</td>
    </tr>
    <tr>
      <th>08_total_time(trauma)</th>
      <td>414.17</td>
      <td>327.65</td>
      <td>383.59</td>
      <td>349.00</td>
      <td>341.44</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
<div class="section" id="end">
<h2>End<a class="headerlink" href="#end" title="Permalink to this headline">¶</a></h2>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./src/notebooks/01_foss_sim"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="../../front_page.html" title="previous page">Welcome</a>
    <a class='right-next' id="next-link" href="02_ciw.html" title="next page">CiW</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Thomas Monks<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../../../_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>